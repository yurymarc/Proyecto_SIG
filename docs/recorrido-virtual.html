<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recorrido Exacto - Barrio Palermo Sur</title>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f0f0f0; }
    #cesiumContainer { width: 100%; height: 100%; }
  </style>
</head>
<body>
<div id="cesiumContainer"></div>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
<script>
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxYTE1ODFiZS05OTNhLTQ2ZDMtYWQyZi0yNDIyMDc1MjFiZWEiLCJpZCI6MzMxMzE4LCJpYXQiOjE3NTUwMjU4NTd9.mRc9Kqm3aGWap7lYt4nQcw2UKRFlVFNYFwPelgX1L_M';

const viewer = new Cesium.Viewer('cesiumContainer', {
    sceneMode: Cesium.SceneMode.SCENE3D,
    baseLayerPicker: true,
    timeline: true,
    animation: true
});

const alturaPorPiso = 3;

// Cargar edificios extruidos
async function loadPredios() {
    const predios = await Cesium.GeoJsonDataSource.load('INSUMOS/CONST_PALERMO_SUR.geojson', { clampToGround: false });
    viewer.dataSources.add(predios);

    predios.entities.values.forEach(e => {
        const pol = e.polygon;
        if (!pol) return;
        const props = e.properties || {};
        const pisos = props.CONNPISOS && !isNaN(+props.CONNPISOS.getValue?.()) ? +props.CONNPISOS.getValue() : 2;
        const altura = pisos * alturaPorPiso;

        pol.material = Cesium.Color.fromCssColorString("#7a8a50").withAlpha(0.9);
        pol.outline = true;
        pol.outlineColor = Cesium.Color.BLACK;
        pol.extrudedHeight = altura;
        pol.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
    });
}

// Recorrido exacto sobre los vértices de las vías
async function loadWalkerExacto() {
    const rutas = await Cesium.GeoJsonDataSource.load('INSUMOS/RUTAS_GEO/RUTAS_Palermo_Sur_Ajustadas_2.geojson', { clampToGround: true });
    viewer.dataSources.add(rutas);

    rutas.entities.values.forEach(e => {
        if (e.polyline) {
            e.polyline.material = Cesium.Color.RED;
            e.polyline.width = 3;
        }
    });

    const sampledPos = new Cesium.SampledPositionProperty();
    let currentTime = Cesium.JulianDate.now();
    const velocidad = 4.5; // m/s

    // Recorrer cada polilínea y todos sus vértices exactamente
    rutas.entities.values.forEach(e => {
        if (e.polyline && e.polyline.positions) {
            const positions = e.polyline.positions.getValue(currentTime);
            for (let i = 0; i < positions.length - 1; i++) {
                const start = positions[i];
                const end = positions[i + 1];
                const dist = Cesium.Cartesian3.distance(start, end);
                const duration = dist / velocidad;
                currentTime = Cesium.JulianDate.addSeconds(currentTime, duration, new Cesium.JulianDate());
                sampledPos.addSample(currentTime, end);
            }
        }
    });

    const walker = viewer.entities.add({
        position: sampledPos,
        orientation: new Cesium.VelocityOrientationProperty(sampledPos),
        model: {
            uri: 'INSUMOS/Cesium_Man.glb',
            scale: 1.5,
            runAnimations: true
        },
        path: {
            resolution: 1,
            material: new Cesium.PolylineGlowMaterialProperty({ glowPower: 0.3, color: Cesium.Color.YELLOW }),
            width: 3
        }
    });

    viewer.trackedEntity = walker;
}

// Ejecutar cargas
loadPredios();
loadWalkerExacto();

// Cámara inicial
viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(-74.11023496302883, 4.541232778615113, 1200),
    orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }
});
</script>
</body>
</html>



